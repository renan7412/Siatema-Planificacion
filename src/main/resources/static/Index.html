<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Login | Planificación Pública</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <style>
        body { font-family: Arial, sans-serif; background-color: #9fbae8; padding: 30px; }
        .form-container { max-width: 600px; margin: auto; background-color: #b7cbee; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        input, button { width: 100%; padding: 10px; margin: 10px 0; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
<!-- background: white -->
<div class="form-container">
    <h2>Planificación Pública</h2>
    <!-- <a href="/admin/adminPanel" class="btn btn-primary">Ir al Admin Panel</a> -->
        <div class="container mt-5">
            <div class="card p-4 shadow-sm">
                <h2 class="mb-4">Inicio de Sesión</h2>
                <form id="loginForm">
                    <div class="mb-3">
                        <label for="username" class="form-label">Usuario</label>
                        <input type="text" class="form-control" id="username" required />
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Contraseña</label>
                        <input type="password" class="form-control" id="password" required />
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Ingresar</button>
                </form>
                <div id="result" class="mt-3"></div>
            </div>
        </div>
</div>

<script>
    const API_URL = "http://localhost:8080"; // Ajusta si tu backend usa otro prefijo

    document.getElementById("loginForm").addEventListener("submit", function(e) {
        e.preventDefault(); // Evita recarga
        const username = document.getElementById("username").value.trim();
        const password = document.getElementById("password").value.trim();
        login(username, password);

        async function login(username, password) {
            const result = document.getElementById("result");

            // Validación básica

            if (username === "" || password === "") {
                result.innerHTML = '<p class="error">Todos los campos son obligatorios.</p>';
                return;
            }

            try {
                const res = await fetch(`${API_URL}/auth/login`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ username, password })
                });

                if (!res.ok) {
                    const msg = await res.text();
                    result.innerHTML = `<p class="error"> ${msg}</p>`;
                    return;
                }

                const data = await res.json(); // { token: "..." }
                if (data.token && data.token.split(".").length === 3){   // .includes
                    localStorage.setItem("jwtToken", data.token);
                    window.location.href = "/dashboard.html";
                } else {
                    result.innerHTML = `<p class="success">Token inválido recibido</p>`;
                }

                // setTimeout(() => window.location.href = "dashboard.html", 1000)

            } catch (error) {
                console.error("Error:", error);
                result.innerHTML = `<p class="error">Error de conexión con el servidor</p>`;
            }
        }
    });
</script>
</body>
</html>
